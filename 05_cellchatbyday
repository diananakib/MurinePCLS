# run_cellchat_mouse.R
# General CellChat (Jin et al. 2022, https://doi.org/10.1038/s41467-021-21246-9) pipeline adapted to murine PCLS dataset

# Load packages
library(CellChat)
library(patchwork)
library(ggplot2)
library(Seurat)

# Setup ----
# Load your Seurat object
group.by <- "genlab_pub"  
data.input <- GetAssayData(seurat, slot = "data")  # normalized data
meta <- seurat@meta.data

#  Create CellChat Object
cellchat <- createCellChat(object = data.input, meta = meta, group.by = group.by)

# Set database to use (murine here)
CellChatDB <- CellChatDB.mouse
cellchat@DB <- CellChatDB

# Preprocessing
cellchat <- subsetData(cellchat)                            # subset signaling genes
cellchat <- identifyOverExpressedGenes(cellchat)            # overexpressed genes
cellchat <- identifyOverExpressedInteractions(cellchat)     # overexpressed interactions
cellchat <- projectData(cellchat, PPI.mouse)                # project onto PPI

# Compute communications
cellchat <- computeCommunProb(cellchat, raw.use = FALSE)
cellchat <- filterCommunication(cellchat, min.cells = 10)
cellchat <- computeCommunProbPathway(cellchat)
cellchat <- aggregateNet(cellchat)

# Compute Centrality
cellchat <- netAnalysis_computeCentrality(cellchat)

### Visualizations

# Overview of number of interactions and strength
pdf("plots/cellchat_circle_interactions.pdf", width = 6, height = 6)
netVisual_circle(cellchat@net$count, vertex.weight = as.numeric(table(cellchat@idents)), 
                 weight.scale = T, label.edge= F)
dev.off()

# Heatmap of interaction strengths
pdf("plots/cellchat_heatmap.pdf", width = 6, height = 6)
netVisual_heatmap(cellchat)
dev.off()

# Bubble plot: top pathways to visiualize
pdf("plots/cellchat_bubble_top_pathways.pdf", width = 8, height = 6)
netVisual_bubble(cellchat, remove.isolate = TRUE)
dev.off()

# Pathway-specific network to visualize
pdf("plots/cellchat_pathway_MIF.pdf", width = 7, height = 6)
netVisual_aggregate(cellchat, signaling = "MIF", layout = "circle")
dev.off()

# Save CellChat object
saveRDS(cellchat, file = "results/cellchat_mouse.rds")
